# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: .NET

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: "true"

jobs:
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
  
    - name: ğŸ©º Start Otel Collector
      run: >
        mkdir -p ${{runner.temp}}/test-results/otel/;
        chmod -R 777 ${{runner.temp}}/test-results/otel/;
        docker run --rm
        -d
        -p 4317:4317
        -v ${{runner.temp}}/test-results/otel/:/mnt/otel-export
        -v ./otel-exporter.yaml:/mnt/otel-config.yaml
        -e ASPIRE_ENDPOINT=http://host.docker.internal:14317
        otel/opentelemetry-collector-contrib:latest
        --config /mnt/otel-config.yaml
  
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x
        dotnet-quality: 'preview'
  
    - name: ğŸ”’ Trust Dev Cert
      run: dotnet dev-certs https --trust

    # See https://github.com/dotnet/aspire/issues/13720
    - name: ğŸ¤” Work around persistent resource generated password
      run: dotnet user-secrets --project src/AppHost set 'Parameters:cache-password' "aA1?$(new-guid)"

    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ğŸ› ï¸ Build
      run: dotnet build

    - name: ğŸ§ª Test
      run: dotnet test --results-directory ${{runner.temp}}/test-results
      env:
        DCP_DIAGNOSTICS_LOG_LEVEL: debug
        ASPIRE__TEST__DCPLOGBASEPATH: ${{runner.temp}}/test-results/dcp
        DCP_PRESERVE_EXECUTABLE_LOGS: 1      

    - name: ğŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: test-results
        path: ${{runner.temp}}/test-results
